<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Python单例模式 | wangjunget</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.d2b52029.css" as="style"><link rel="preload" href="/assets/js/app.9ff94b6f.js" as="script"><link rel="preload" href="/assets/js/3.49a4f85b.js" as="script"><link rel="preload" href="/assets/js/40.a6499166.js" as="script"><link rel="prefetch" href="/assets/js/10.5c9ac91e.js"><link rel="prefetch" href="/assets/js/11.2d7ca541.js"><link rel="prefetch" href="/assets/js/12.028623ee.js"><link rel="prefetch" href="/assets/js/13.7ca5c050.js"><link rel="prefetch" href="/assets/js/14.c1eede93.js"><link rel="prefetch" href="/assets/js/15.263c9f1a.js"><link rel="prefetch" href="/assets/js/16.02e6fd27.js"><link rel="prefetch" href="/assets/js/17.f1df8bd6.js"><link rel="prefetch" href="/assets/js/18.572eb5fa.js"><link rel="prefetch" href="/assets/js/19.f10e11a0.js"><link rel="prefetch" href="/assets/js/2.938d3f47.js"><link rel="prefetch" href="/assets/js/20.57228dc9.js"><link rel="prefetch" href="/assets/js/21.f97f3e2c.js"><link rel="prefetch" href="/assets/js/22.c8ff24b1.js"><link rel="prefetch" href="/assets/js/23.07f08242.js"><link rel="prefetch" href="/assets/js/24.22dc477e.js"><link rel="prefetch" href="/assets/js/25.780bbedd.js"><link rel="prefetch" href="/assets/js/26.52d914a9.js"><link rel="prefetch" href="/assets/js/27.acdeb9c3.js"><link rel="prefetch" href="/assets/js/28.64c30fba.js"><link rel="prefetch" href="/assets/js/29.d9cee65a.js"><link rel="prefetch" href="/assets/js/30.d7bd987d.js"><link rel="prefetch" href="/assets/js/31.e96f3ecb.js"><link rel="prefetch" href="/assets/js/32.b77c3adf.js"><link rel="prefetch" href="/assets/js/33.54deba64.js"><link rel="prefetch" href="/assets/js/34.39ad3fbe.js"><link rel="prefetch" href="/assets/js/35.b00ac0d1.js"><link rel="prefetch" href="/assets/js/36.1d5b6d0f.js"><link rel="prefetch" href="/assets/js/37.ba3b3540.js"><link rel="prefetch" href="/assets/js/38.2043d007.js"><link rel="prefetch" href="/assets/js/39.a0bb53a0.js"><link rel="prefetch" href="/assets/js/4.d9fe853f.js"><link rel="prefetch" href="/assets/js/41.b8c24b86.js"><link rel="prefetch" href="/assets/js/42.4debb65f.js"><link rel="prefetch" href="/assets/js/43.c072ec3a.js"><link rel="prefetch" href="/assets/js/44.dc67c285.js"><link rel="prefetch" href="/assets/js/45.453f7c18.js"><link rel="prefetch" href="/assets/js/46.504fd32d.js"><link rel="prefetch" href="/assets/js/5.ff12ba21.js"><link rel="prefetch" href="/assets/js/6.f5314280.js"><link rel="prefetch" href="/assets/js/7.3f6fd47e.js"><link rel="prefetch" href="/assets/js/8.3bc8ce07.js"><link rel="prefetch" href="/assets/js/9.dc730228.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d2b52029.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">wangjunget</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">分类</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>前端</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/Vue/" class="nav-link">Vue</a></li><li class="dropdown-subitem"><a href="/JavaScript/" class="nav-link">JavaScript</a></li><li class="dropdown-subitem"><a href="/Css/" class="nav-link">Css</a></li></ul></li><li class="dropdown-item"><h4>开发工具</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/Python/" class="nav-link router-link-active">Python</a></li><li class="dropdown-subitem"><a href="/Git/" class="nav-link">Git</a></li><li class="dropdown-subitem"><a href="/Linux/" class="nav-link">Linux</a></li></ul></li></ul></div></div> <a href="https://github.com/wangjunget/blog-vuepress" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">分类</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>前端</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/Vue/" class="nav-link">Vue</a></li><li class="dropdown-subitem"><a href="/JavaScript/" class="nav-link">JavaScript</a></li><li class="dropdown-subitem"><a href="/Css/" class="nav-link">Css</a></li></ul></li><li class="dropdown-item"><h4>开发工具</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/Python/" class="nav-link router-link-active">Python</a></li><li class="dropdown-subitem"><a href="/Git/" class="nav-link">Git</a></li><li class="dropdown-subitem"><a href="/Linux/" class="nav-link">Linux</a></li></ul></li></ul></div></div> <a href="https://github.com/wangjunget/blog-vuepress" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Python</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Python/" class="sidebar-link">关于</a></li><li><a href="/Python/深入理解Python中的元类.html" class="sidebar-link">深入理解Python中的元类</a></li><li><a href="/Python/Python单例模式.html" class="active sidebar-link">Python单例模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Python/Python单例模式.html#单例模式" class="sidebar-link">单例模式</a></li><li class="sidebar-sub-header"><a href="/Python/Python单例模式.html#实现单例模式的几种方式" class="sidebar-link">实现单例模式的几种方式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Python/Python单例模式.html#_1-使用模块" class="sidebar-link">1.使用模块</a></li><li class="sidebar-sub-header"><a href="/Python/Python单例模式.html#_2-使用装饰器" class="sidebar-link">2.使用装饰器</a></li><li class="sidebar-sub-header"><a href="/Python/Python单例模式.html#_3-使用类" class="sidebar-link">3.使用类</a></li><li class="sidebar-sub-header"><a href="/Python/Python单例模式.html#_4-基于-new-方法实现（推荐使用，方便）" class="sidebar-link">4.基于_new_方法实现（推荐使用，方便）</a></li><li class="sidebar-sub-header"><a href="/Python/Python单例模式.html#_5-基于metaclass元类方式实现" class="sidebar-link">5.基于metaclass元类方式实现</a></li></ul></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="python单例模式"><a href="#python单例模式" aria-hidden="true" class="header-anchor">#</a> Python单例模式</h1> <p>看到一篇关于Python单例模式总结的文章，转载过来记录一下。本文是在转载原文的基础上，添加了自己的一些理解。
原文：<a href="https://www.cnblogs.com/huchong/p/8244279.html" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/huchong/p/8244279.html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="单例模式"><a href="#单例模式" aria-hidden="true" class="header-anchor">#</a> 单例模式</h2> <p><strong>单例模式</strong> （Singleton Pattern）是一种常用的软件设计模式，该模式的主要目的是确保某一个类只有一个实例存在。当你希望在整个系统中，某个类只能出现一个实例时，单例对象就能派上用场。
比如，某个服务器程序的配置信息存放在一个文件中，客户端通过一个 AppConfig 的类来读取配置文件的信息。如果在程序运行期间，有很多地方都需要使用配置文件的内容，也就是说，很多地方都需要创建 AppConfig 对象的实例，这就导致系统中存在多个 AppConfig 的实例对象，而这样会严重浪费内存资源，尤其是在配置文件内容很多的情况下。事实上，类似 AppConfig 这样的类，我们希望在程序运行期间只存在一个实例对象。
在 Python 中，我们可以用多种方法来实现单例模式。</p> <h2 id="实现单例模式的几种方式"><a href="#实现单例模式的几种方式" aria-hidden="true" class="header-anchor">#</a> 实现单例模式的几种方式</h2> <p>实现单例模式有很多方式，这里介绍几种。</p> <h3 id="_1-使用模块"><a href="#_1-使用模块" aria-hidden="true" class="header-anchor">#</a> 1.使用模块</h3> <p>其实，Python 的模块就是天然的单例模式，因为模块在第一次导入时，会生成 .pyc 文件，当第二次导入时，就会直接加载 .pyc 文件，而不会再次执行模块代码。因此，我们只需把相关的函数和数据定义在一个模块中，就可以获得一个单例对象了。如果我们真的想要一个单例类，可以考虑这样做：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>
singleton <span class="token operator">=</span> Singleton<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>将上面的代码保存在文件 <code>mysingleton.py</code>中，要使用时，直接在其他文件中导入此文件中的对象，这个对象即是单例模式的对象。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> a <span class="token keyword">import</span> singleton
</code></pre></div><p>通过这种方式，每次调用对象<code>singleton</code>使用的都是同一个对象。</p> <h3 id="_2-使用装饰器"><a href="#_2-使用装饰器" aria-hidden="true" class="header-anchor">#</a> 2.使用装饰器</h3> <p>使用装饰器的目的是，在每次调用类对象时判断是否存在已经实例化的对象，如果实例对象不存在则创建；如果实例对象已经存在则返回已经存在的实例对象，通过这种方式确保类对象只存在一个实例化对象。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">Singleton</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>
    _instance <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">def</span> <span class="token function">_singleton</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> cls <span class="token keyword">not</span> <span class="token keyword">in</span> _instance<span class="token punctuation">:</span>
            _instance<span class="token punctuation">[</span>cls<span class="token punctuation">]</span> <span class="token operator">=</span> cls<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kargs<span class="token punctuation">)</span>
        <span class="token keyword">return</span> _instance<span class="token punctuation">[</span>cls<span class="token punctuation">]</span>

    <span class="token keyword">return</span> _singleton

@Singleton
<span class="token keyword">class</span> <span class="token class-name">A</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    a <span class="token operator">=</span> <span class="token number">1</span>
    
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>x <span class="token operator">=</span> x


a1 <span class="token operator">=</span> A<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
a2 <span class="token operator">=</span> A<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="_3-使用类"><a href="#_3-使用类" aria-hidden="true" class="header-anchor">#</a> 3.使用类</h3> <p>通过<code>classmethod</code>创建类方法，每次调用类方法<code>instance</code>时会判断是否存在属性<code>Singleton._instance</code>，（<code>_instance</code>属性是类<code>Singleton</code>的实例化对象），如果属性存在说明类已经实例化，返回已经实例化的对象；如果属性不存在，则将类实例化并赋值给属性<code>_instance</code>并返回该属性。这样保证只有一个实例对象。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>

    @<span class="token builtin">classmethod</span>
    <span class="token keyword">def</span> <span class="token function">instance</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token string">&quot;_instance&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            cls<span class="token punctuation">.</span>_instance <span class="token operator">=</span> cls<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        <span class="token keyword">return</span> cls<span class="token punctuation">.</span>_instance
</code></pre></div><p>但是这种方式在多线程中会出现个问题</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>

    @<span class="token builtin">classmethod</span>
    <span class="token keyword">def</span> <span class="token function">instance</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>Singleton<span class="token punctuation">,</span> <span class="token string">&quot;_instance&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            Singleton<span class="token punctuation">.</span>_instance <span class="token operator">=</span> Singleton<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        <span class="token keyword">return</span> Singleton<span class="token punctuation">.</span>_instance

<span class="token keyword">import</span> threading

<span class="token keyword">def</span> <span class="token function">task</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    obj <span class="token operator">=</span> Singleton<span class="token punctuation">.</span>instance<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    t <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>task<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">[</span>i<span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre></div><p>程序的输出结果如下：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>Singleton <span class="token builtin">object</span> at <span class="token number">0x02C933D0</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>Singleton <span class="token builtin">object</span> at <span class="token number">0x02C933D0</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>Singleton <span class="token builtin">object</span> at <span class="token number">0x02C933D0</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>Singleton <span class="token builtin">object</span> at <span class="token number">0x02C933D0</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>Singleton <span class="token builtin">object</span> at <span class="token number">0x02C933D0</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>Singleton <span class="token builtin">object</span> at <span class="token number">0x02C933D0</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>Singleton <span class="token builtin">object</span> at <span class="token number">0x02C933D0</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>Singleton <span class="token builtin">object</span> at <span class="token number">0x02C933D0</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>Singleton <span class="token builtin">object</span> at <span class="token number">0x02C933D0</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>Singleton <span class="token builtin">object</span> at <span class="token number">0x02C933D0</span><span class="token operator">&gt;</span>
</code></pre></div><p>这样看来，这里只有一个实例对象并不能说明多线程行不通。看起来也没有问题，那是因为执行速度过快，如果在init方法中有一些IO操作，就会发现问题了，下面我们通过<code>time.sleep</code>模拟</p> <p>我们在上面<code>__init__</code>方法中加入以下代码：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">import</span> time
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre></div><p>重新执行程序后，结果如下:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>Singleton <span class="token builtin">object</span> at <span class="token number">0x034A3410</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>Singleton <span class="token builtin">object</span> at <span class="token number">0x034BB990</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>Singleton <span class="token builtin">object</span> at <span class="token number">0x034BB910</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>Singleton <span class="token builtin">object</span> at <span class="token number">0x034ADED0</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>Singleton <span class="token builtin">object</span> at <span class="token number">0x034E6BD0</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>Singleton <span class="token builtin">object</span> at <span class="token number">0x034E6C10</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>Singleton <span class="token builtin">object</span> at <span class="token number">0x034E6B90</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>Singleton <span class="token builtin">object</span> at <span class="token number">0x034BBA30</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>Singleton <span class="token builtin">object</span> at <span class="token number">0x034F6B90</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>Singleton <span class="token builtin">object</span> at <span class="token number">0x034E6A90</span><span class="token operator">&gt;</span>
</code></pre></div><p>这里就会看到，每一个线程生成不同的实例对象，并不符合之前的预期。产生这样的结果是因为前面的线程在进行类的实例化的过程中进行IO操作，消耗大量时间，而由于多线程模式后面的线程并不会等待前面的类实例化完成以后才开始执行，所以就导致每个线程在调用类方法时类不存在<code>_instance</code>属性，继而每个线程都生成一个新的实例对象。
<strong>解决办法</strong> ：加锁！未加锁部分并发执行,加锁部分串行执行,速度降低,但是保证了数据安全。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> time
<span class="token keyword">import</span> threading
<span class="token keyword">class</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    _instance_lock <span class="token operator">=</span> threading<span class="token punctuation">.</span>Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    @<span class="token builtin">classmethod</span>
    <span class="token keyword">def</span> <span class="token function">instance</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> Singleton<span class="token punctuation">.</span>_instance_lock<span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>Singleton<span class="token punctuation">,</span> <span class="token string">&quot;_instance&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                Singleton<span class="token punctuation">.</span>_instance <span class="token operator">=</span> Singleton<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        <span class="token keyword">return</span> Singleton<span class="token punctuation">.</span>_instance


<span class="token keyword">def</span> <span class="token function">task</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    obj <span class="token operator">=</span> Singleton<span class="token punctuation">.</span>instance<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    t <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>task<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">[</span>i<span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
obj <span class="token operator">=</span> Singleton<span class="token punctuation">.</span>instance<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
</code></pre></div><h3 id="_4-基于-new-方法实现（推荐使用，方便）"><a href="#_4-基于-new-方法实现（推荐使用，方便）" aria-hidden="true" class="header-anchor">#</a> 4.基于__new__方法实现（推荐使用，方便）</h3> <p>通过上面例子，我们可以知道，当我们实现单例时，为了保证线程安全需要在内部加入锁。</p> <p>我们知道，当我们实例化一个对象时，是先执行了类的<code>__new__</code>方法（我们没写时，默认调用<code>object.__new__</code>），实例化对象；然后再执行类的<code>__init__</code>方法，对这个对象进行初始化，所有我们可以基于这个，实现单例模式。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> threading
<span class="token keyword">class</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    _instance_lock <span class="token operator">=</span> threading<span class="token punctuation">.</span>Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>


    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>Singleton<span class="token punctuation">,</span> <span class="token string">&quot;_instance&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">with</span> Singleton<span class="token punctuation">.</span>_instance_lock<span class="token punctuation">:</span>
                <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>Singleton<span class="token punctuation">,</span> <span class="token string">&quot;_instance&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    Singleton<span class="token punctuation">.</span>_instance <span class="token operator">=</span> <span class="token builtin">object</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>cls<span class="token punctuation">)</span>  
        <span class="token keyword">return</span> Singleton<span class="token punctuation">.</span>_instance

obj1 <span class="token operator">=</span> Singleton<span class="token punctuation">(</span><span class="token punctuation">)</span>
obj2 <span class="token operator">=</span> Singleton<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>obj1<span class="token punctuation">,</span>obj2<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">task</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    obj <span class="token operator">=</span> Singleton<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    t <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>task<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">[</span>i<span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>采用这种方式的单例模式，以后实例化对象时，和平时实例化对象的方法一样 <code>obj = Singleton()</code></p> <h3 id="_5-基于metaclass元类方式实现"><a href="#_5-基于metaclass元类方式实现" aria-hidden="true" class="header-anchor">#</a> 5.基于metaclass元类方式实现</h3> <p><a href="https://www.cnblogs.com/wangjunget/articles/9748241.html" target="_blank" rel="noopener noreferrer">元类详细介绍<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> threading

<span class="token keyword">class</span> <span class="token class-name">SingletonType</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    _instance_lock <span class="token operator">=</span> threading<span class="token punctuation">.</span>Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token string">&quot;_instance&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">with</span> SingletonType<span class="token punctuation">.</span>_instance_lock<span class="token punctuation">:</span>
                <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token string">&quot;_instance&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    cls<span class="token punctuation">.</span>_instance <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span>SingletonType<span class="token punctuation">,</span>cls<span class="token punctuation">)</span><span class="token punctuation">.</span>__call__<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        <span class="token keyword">return</span> cls<span class="token punctuation">.</span>_instance

<span class="token keyword">class</span> <span class="token class-name">Foo</span><span class="token punctuation">(</span>metaclass<span class="token operator">=</span>SingletonType<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name


obj1 <span class="token operator">=</span> Foo<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span>
obj2 <span class="token operator">=</span> Foo<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>obj1<span class="token punctuation">,</span>obj2<span class="token punctuation">)</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Python/深入理解Python中的元类.html" class="prev">深入理解Python中的元类</a></span> <!----></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.9ff94b6f.js" defer></script><script src="/assets/js/3.49a4f85b.js" defer></script><script src="/assets/js/40.a6499166.js" defer></script>
  </body>
</html>
